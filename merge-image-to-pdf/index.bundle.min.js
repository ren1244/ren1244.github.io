!function(){"use strict";let e=!1,t=0,n=null;function o(t,o){n=o;const i=96*o.pageW/72;t.innerHTML=`\n    <div class="page-wrapper" style="width:${Math.round(i)+2}px">\n        <ol>\n            <li>支援下方式匯入圖片：\n                <ul>\n                    <li>在格子點兩下，透過檔案對話盒選擇圖片</li>\n                    <li>從檔案總管把圖片拖曳到格子上</li>\n                    <li>選擇格子後，用 CTRL+V 貼上圖片</li>\n                </ul>\n            </li>\n            <li>如需刪除圖片，可以點選格子後按 delete 鍵</li>\n        </ol>\n\n        <div id="input-area-footer">\n            <button id="addPageBtn">新增一頁</button>\n            <button id="doneBtn">完成</button>\n        </div>\n    </div>`,document.querySelector("#addPageBtn").addEventListener("click",r),document.querySelector("#doneBtn").addEventListener("click",(()=>{let e=new CustomEvent("closeImgPasteTable",{detail:Array.from(document.querySelectorAll(".page-div")).map((e=>Array.from(e.querySelectorAll(".preview-cell")).map((e=>{let t=e.querySelector("img");return null!==t?{w:parseInt(t.dataset.imgW,10),h:parseInt(t.dataset.imgH,10),base64:t.src}:null}))))});document.dispatchEvent(e)})),r(),document.addEventListener("paste",(e=>{p((e.clipboardData||window.clipboardData).files)})),document.addEventListener("keyup",(t=>{"Delete"!==t.key&&"Backspace"!==t.key||e&&(e.innerHTML="")}))}function i(t){for(e&&e.classList.toggle("preview-cell-select",!1),e=t.target;null!==e&&!e.classList.contains("preview-cell");)e=e.parentElement;e.classList.toggle("preview-cell-select",!0)}function r(){const e=96/72,o=n.pageW*e,r=n.pageH*e,p=n.margin*e,s=n.nCols,c=n.nRows,u=n.gap*e,h=p,g=p,m=(o-2*p-u*(s-1))/s,f=(r-2*p-u*(c-1))/c,v=m+u,y=f+u;let b="page-"+ ++t,$=document.createElement("div");$.setAttribute("id",b);let w=document.querySelector("#input-area-footer");w.parentElement.insertBefore($,w);let E=document.createElement("div");E.setAttribute("style",`width:${Math.round(o)}px;height:${Math.round(r)}px;`),E.setAttribute("class","page-div"),E.setAttribute("id",b),$.appendChild(E),E.innerHTML=Array.from({length:c},((e,t)=>Array.from({length:s},((e,n)=>`<div class="preview-cell" style="left:${Math.round(h+v*n)}px;top:${Math.round(g+y*t)}px;width:${Math.round(m)}px;height:${Math.round(f)}px"></div>`)).join(""))).join("");let L=document.createElement("div");L.setAttribute("class","page-footer"),L.innerHTML=`<span data-wrapper-id="${b}">刪除</span>`,$.appendChild(L),E.querySelectorAll(".preview-cell").forEach((e=>{e.addEventListener("click",i),e.addEventListener("dblclick",l),e.addEventListener("drop",a,!0),e.addEventListener("dragleave",(function(e){e.preventDefault(),e.stopPropagation()}),!0),e.addEventListener("dragover",(function(e){e.preventDefault(),e.stopPropagation()}),!0)})),L.querySelector("span").addEventListener("click",d)}function l(e){i(e);let t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept","image/*"),t.addEventListener("change",(e=>{p(e.target.files)})),t.click()}function a(e){i(e),e.preventDefault(),e.stopPropagation(),p(e.dataTransfer.files)}function d(e){let t=e.target.dataset.wrapperId;console.log(e.target.dataset);let n=document.querySelector("#"+t);n.parentElement.removeChild(n)}function p(t){const o=(n.pageW-2*n.margin-n.gap*(n.nCols-1))/n.nCols*n.ppi/72,i=(n.pageH-2*n.margin-n.gap*(n.nRows-1))/n.nRows*n.ppi/72;if(!e)return;let r=0;for(;r<t.length&&0!==t[r].type.search(/^image/);++r);if(r>=t.length)return;let l=t[r],a=e,d=l.type;new Promise((e=>{let t=new FileReader;t.onload=function(){e(this.result)},t.readAsDataURL(l)})).then((e=>new Promise((t=>{let r=new Image;r.onload=function(){let r=this.width,l=this.height;if("image/jpeg"===d&&(n.ppi<=0||r<=o&&l<=i))t(e);else{let e=document.createElement("canvas"),a=n.ppi>0?Math.min(o/r,i/l,1):1,d=Math.round(r*a),p=Math.round(l*a);e.width=d,e.height=p;let s=e.getContext("2d");s.fillStyle="#FFF",s.fillRect(0,0,d,p),s.drawImage(this,0,0,r,l,0,0,d,p),t(e.toDataURL("image/jpeg",n.quality/100))}},r.src=e})))).then((e=>{let t=new Image;t.onload=function(){let e=this.width,n=this.height;this.dataset.imgW=e,this.dataset.imgH=n,this.setAttribute("style","max-width:100%;max-height:100%"),a.innerHTML="",a.appendChild(t)},t.src=e}))}function s(){this.idCount=0,this.data=[]}function c(e){let t=Array.from(atob(e),(e=>e.codePointAt())),n=t.length%4>0?4-t.length%4:0;for(;n-- >0;)t.push(0);let o="";for(let e=0,n=t.length;e+3<n;e+=4){let n=t[e]<<8|t[e+1],i=t[e+2]<<8|t[e+3],r="";for(let e=0;e<5;++e){let e=n%85<<16|i%85,t=e%85;n=(n-n%85)/85,i=(i-i%85)/85+(e-e%85)/85,n+=i>>>16,i&=65535,r=String.fromCodePoint(33+t)+r}o+=r}return o}s.prototype.addObject=function(e,t,n){"string"==typeof t&&(e.Length=t.length);let o,i=[];o=void 0===n?++this.idCount:n,i.push(`${o} 0 obj`),i.push("<<");for(let t in e)i.push(`/${t} ${e[t]}`);i.push(">>"),"string"==typeof t&&(i.push("stream"),i.push(t),i.push("endstream")),i.push("endobj"),this.data[o-1]=i.join("\n")},s.prototype.preserveId=function(){return++this.idCount},s.prototype.output=function(e){let t="%PDF-1.4\n%§§",n=["0000000000 65535 f "],o=t.length+3;return this.data.forEach((e=>{let t=o.toString();t="0".repeat(10-t.length)+t,n.push(`${t} 00000 n `),o+=e.length+1})),`${t}\n${this.data.join("\n")}\nxref\n0 ${this.data.length+1}\n${n.join("\n")}\ntrailer\n<<\n/Size ${this.data.length+1}\n/Root ${e} 0 R\n>>\nstartxref\n${o}\n%%EOF\n`},s.prototype.toDataUrl=function(e){return"data:application/pdf;base64,"+function(e){const t=new TextEncoder;return btoa(Array.from(t.encode(e),(e=>String.fromCodePoint(e))).join(""))}(this.output(e))};let u=!1;function h(){let e={},t={A4v:[210/25.4*72,297/25.4*72],A4h:[297/25.4*72,210/25.4*72]}[document.querySelector("#paper").value];return e.pageW=t[0],e.pageH=t[1],e.margin=parseFloat(document.querySelector("#config-margin").value)/25.4*72,e.nCols=parseInt(document.querySelector("#config-ncols").value,10),e.nRows=parseInt(document.querySelector("#config-nrows").value,10),e.gap=parseFloat(document.querySelector("#config-gap").value)/25.4*72,e.showCell=document.querySelector("#config-cell-show").checked,e.quality=parseFloat(document.querySelector("#config-quality").value),e.ppi=parseInt(document.querySelector("#config-ppi").value,10),e.strokeWidth=.5,e}const g=document.querySelector("#config"),m=document.querySelector("#input-area"),f=document.querySelector("iframe");let v=null;g.innerHTML='\n    <div>\n        <p style="font-weight:bold;border:1px solid black">本軟體只在使用者瀏覽器上計算並輸出，不會上傳任何資料到伺服器</p>\n    </div>\n    <table id="config-table">\n    <tr>\n        <td colspan="2">\n            <h3>紙張</h3>\n        </td>\n    </tr>\n    <tr>\n        <td>尺寸</td>\n        <td>\n            <select id="paper">\n                <option value="A4v">A4 (直向)</option>\n                <option value="A4h">A4 (橫向)</option>\n            </select>\n        </td>\n    </tr>\n    <tr>\n        <td>邊界</td>\n        <td><input id="config-margin" type="number" value="10" step="0.1"> mm</td>\n    </tr>\n    <tr>\n        <td colspan="2">\n            <h3>分割</h3>\n        </td>\n    </tr>\n    <tr>\n        <td>欄數</td>\n        <td><input id="config-ncols" type="number" value="3"></td>\n    </tr>\n    <tr>\n        <td>列數</td>\n        <td><input id="config-nrows" type="number" value="5"></td>\n    </tr>\n    <tr>\n        <td>間隔</td>\n        <td><input id="config-gap" type="number" value="2" step="0.1"> mm</td>\n    </tr>\n    <tr>\n        <td></td>\n        <td><input id="config-cell-show" type="checkbox"> 顯示邊框</td>\n    </tr>\n    <tr>\n        <td colspan="2">\n            <h3>圖片設定</h3>\n        </td>\n    </tr>\n    <tr>\n        <td>品質</td>\n        <td><input id="config-quality" type="number" value="95"> (0~100)</td>\n    </tr>\n    <tr>\n        <td>縮圖</td>\n        <td>\n            <select id="config-ppi">\n                <option value="150">150 ppi</option>\n                <option value="300" selected>300 ppi</option>\n                <option value="450">450 ppi</option>\n                <option value="600">600 ppi</option>\n                <option value="-1">不縮圖</option>\n            </select> （圖片太大超出這個值才會縮圖）\n        </td>\n    </tr>\n    <tr>\n        <td colspan="2">\n            <button id="config-next">下一步</button>\n        </td>\n    </tr>\n</table>',document.querySelector("#config-next").addEventListener("click",(()=>{let e=new CustomEvent("closeConfig",{detail:h()});document.dispatchEvent(e)})),document.addEventListener("closeConfig",(e=>{v=e.detail,g.setAttribute("style","display:none"),m.removeAttribute("style"),o(m,v)})),document.addEventListener("closeImgPasteTable",(e=>{console.log(e.detail),f.src=function(e,t){const n=t.nCols,o=t.nRows,i=t.pageW,r=t.pageH,l=t.margin,a=t.gap,d=(i-2*l-a*(n-1))/n,p=(r-2*l-a*(o-1))/o,h=d+a,g=p+a;let m=new s,f=m.preserveId(),v=m.preserveId(),y=[],b=[],$=[],w=[];for(let t=0;t<e.length;++t){y.push(m.preserveId()),b.push(m.preserveId());let n=[];for(let o=0;o<e[t].length;++o)e[t][o]&&(e[t][o].id=m.preserveId(),e[t][o].k=o,n.push(e[t][o]));$.push(n),w.push(m.preserveId())}m.addObject({Type:"/Catalog",Pages:`${v} 0 R`},!1,f),m.addObject({Type:"/Pages",Kids:`[${y.map((e=>e+" 0 R")).join(" ")}]`,Count:y.length},!1,v);for(let i=0;i<e.length;++i){const e=i;m.addObject({Type:"/Page",Parent:`${v} 0 R`,Resources:`${b[e]} 0 R`,Contents:`[${w[e]} 0 R]`,MediaBox:`[0 0 ${t.pageW} ${t.pageH}]`},!1,y[e]),m.addObject({ProcSet:"[/PDF /ImageB ]",XObject:`<< ${$[i].map((e=>`/Im${e.id} ${e.id} 0 R`)).join(" ")} >>`},!1,b[e]),$[i].forEach((e=>{let t=c(e.base64.split("base64,")[1]);m.addObject({Type:"/XObject",Subtype:"/Image",Width:e.w,Height:e.h,ColorSpace:"/DeviceRGB",BitsPerComponent:"8",Filter:"[/ASCII85Decode /DCTDecode]"},t+"~>",e.id)}));let r=[];if(t.showCell){let e=[],i=t.strokeWidth;if(t.gap<i)for(let t=0;t<=o;++t){let i=l+g*t;e.push(`${l} ${i} m ${l+n*h} ${i} l`);for(let t=0;t<=n;++t){let n=l+h*t;e.push(`${n} ${l} m ${n} ${l+o*g} l`)}}else for(let t=0;t<o;++t)for(let o=0;o<n;++o)e.push(`${l+h*o} ${l+g*t} ${d} ${p} re`);r.push(`q 2 J 0.25 G ${i} w ${e.join(" ")} S Q`)}$[i].forEach((e=>{let i=t.showCell?t.strokeWidth:0,a=e.w,s=e.h,c=Math.min((d-i)/a,(p-i)/s);a*=c,s*=c;let u=e.k%n*h+l+(d-a)/2,m=(o-1-(e.k/n|0))*g+l+(p-s)/2;r.push(`q ${a} 0 0 ${s} ${u} ${m} cm /Im${e.id} Do Q`)})),m.addObject({},r.join(" "),w[e])}let E=m.output(f);return u&&URL.revokeObjectURL(u),u=URL.createObjectURL(new Blob([E],{type:"application/pdf"})),console.log(u),u}(e.detail,v),m.setAttribute("style","display:none"),f.removeAttribute("style")}))}();
